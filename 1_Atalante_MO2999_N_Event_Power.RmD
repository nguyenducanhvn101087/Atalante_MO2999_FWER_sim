---
title: "Atalante MO2999 N Event Power"
author: "Anh Nguyen Duc"
# date: "12/13/2018"
# output: word_document

output:
  html_document:
    toc: yes
    toc_float: true
    to_depth: 5
    collapsed: false
    smooth_scroll: false
    number_sections: true
    theme: united
  word_document: default
header-includes: \usepackage{docmute}
classoption: landscape
---

```{r,echo=F,message=F,warning=F}
rm(list=ls())
# source('ADA5W_OPTIMAL_MATCHING_12SEP2018_29522.R')
# source('ADA5W_TOLERANCE_MATCHING_12SEP2018_29522.R')
require(knitr)
require(haven)
require(magrittr)
require(gmodels)
require(tidyverse)
require(ldbounds)
require(gsDesign)
require(msm)
require(xlsx)
require(rpact)
require(survival)
require(survminer)
# source("../../../../../../../../Methods/R/survivalSampleSizeMisc.R")
# source('../../../../../../../../Methods/Surv/Non_PH/NPH.R')
knitr::opts_chunk$set(echo = TRUE, cache=FALSE, autodep=FALSE)
# source("https://raw.github.roche.com/adaptR/adaptR-tutorials/master/simpleBoundarySummary.R")
set.seed(21)
```

# Update May 2021

## OS - event projection

Below is from Ignacio Dolado

+ ITT OS of carbo/gem/Bev in ATALANTE's setting:  33.3 months (JCO, Aghajanian 2012); 27.9 months (Lancet Oncol., Pfisterer 2020)

+ ITT OS of carbo/pacl/Bev in ATALANTE's setting: 42.2 months (Lancet Oncol., Coleman 2017) (likely longer since there was a second question of surgery in the recurrent setting also built in the study)

+ ITT OS of carbo/PLD/Bev in ATALANTE's setting:  32.0 months (Lancet Oncol., Pfisterer 2020)

+ ITT OS of carbo/Bev/pacl or PLD or gem in ATALANTE's setting: 26.7 months (Lancet Oncol., Pignata 2021)  

Average of all above is 33 months assumed the same for both ITt and PDL1+

```{r,echo=T,message=F,warning=F}
mOS_ITT_ctr <- 13
hrOS_ITT <- 0.73

mOS_PDL1_ctr <- 15
hrOS_PDL1 <- 0.62

rr <- 2

# accrualIntensity_ITT  <- 600/40 # per protocol
# accrualTime_ITT <- c(0,40)

# actual
accrualIntensity_ITT  <- c(5,6, 19, 21, 15, 14, 7, 10, 9, 10, 11, 10, 12, 13, 11, 8, 12, 12,
                           16, 13, 19, 21, 21, 16, 26, 19, 27, 34, 21, 18, 25, 25, 33, 28, 24,
                           17, 6) 
accrualTime_ITT <- 0:length(accrualIntensity_ITT)


fpi <- as.Date('2016-09-22')

# ITT
# times <- c(56,59,62,65,68,71,74,77,80, 83, 86, 89, 92)
times <- c(74,77,80, 83, 86, 89, 92, 95, 98, 101, 104, 107, 110, 113, 116, 119)

prop_ev_OS_ITT <- getEventProbabilities(time=times, lambda2 = log(2)/mOS_ITT_ctr, hazardRatio = hrOS_ITT, 
                                        allocationRatioPlanned = rr, accrualTime = accrualTime_ITT, 
                                        accrualIntensity = accrualIntensity_ITT)$overallEventProbabilities

event_OS_ITT <- prop_ev_OS_ITT * sum(accrualIntensity_ITT)
event_OS_ITT_low <- event_OS_ITT - qnorm(.975) * sqrt(prop_ev_OS_ITT * (1-prop_ev_OS_ITT) * sum(accrualIntensity_ITT))
event_OS_ITT_upp <- event_OS_ITT + qnorm(.975) * sqrt(prop_ev_OS_ITT * (1-prop_ev_OS_ITT) * sum(accrualIntensity_ITT))

plot(x=fpi+times*30.4375, y=event_OS_ITT, xaxt = "n", ylab="OS events", xlab="Time", col='red', ylim=c(min(event_OS_ITT_low), max(event_OS_ITT_upp)))
points(x=fpi+times*30.4375, y=event_OS_ITT_low, col='blue')
points(x=fpi+times*30.4375, y=event_OS_ITT_upp, col='blue')
axis(1, fpi+times*30.4375, format(fpi+times*30.4375), cex.axis = .7)
text(fpi+times*30.4375, event_OS_ITT+3, labels = event_OS_ITT%>%round, col='red')
text(fpi+times*30.4375, event_OS_ITT_low+3, labels = event_OS_ITT_low%>%round, col='blue')
text(fpi+times*30.4375, event_OS_ITT_upp+3, labels = event_OS_ITT_upp%>%round, col='blue')
legend(x=fpi+times[1]*30.4375,y=500,legend = c('Expected OS events', '95%-CI'), fill = c('red','blue'), bty = 'n')

# PDL1
times <- c(56,59,62,65,68,71,74,77,80, 83, 86, 89, 92)

prop_ev_OS_PDL1 <- getEventProbabilities(time=times, lambda2 = log(2)/mOS_PDL1_ctr, hazardRatio = hrOS_PDL1, 
                                        allocationRatioPlanned = rr, accrualTime = accrualTime_ITT, 
                                        accrualIntensity = accrualIntensity_ITT* .4)$overallEventProbabilities

event_OS_PDL1 <- prop_ev_OS_PDL1 * sum(accrualIntensity_ITT)* .4
event_OS_PDL1_low <- event_OS_PDL1 - qnorm(.975) * sqrt(prop_ev_OS_PDL1 * (1-prop_ev_OS_PDL1) * sum(accrualIntensity_ITT))
event_OS_PDL1_upp <- event_OS_PDL1 + qnorm(.975) * sqrt(prop_ev_OS_PDL1 * (1-prop_ev_OS_PDL1) * sum(accrualIntensity_ITT))

plot(x=fpi+times*30.4375, y=event_OS_PDL1, xaxt = "n", ylab="OS events", xlab="Time", col='red', ylim=c(min(event_OS_PDL1_low), max(event_OS_PDL1_upp)))
points(x=fpi+times*30.4375, y=event_OS_PDL1_low, col='blue')
points(x=fpi+times*30.4375, y=event_OS_PDL1_upp, col='blue')
axis(1, fpi+times*30.4375, format(fpi+times*30.4375), cex.axis = .7)
text(fpi+times*30.4375, event_OS_PDL1+3, labels = event_OS_PDL1%>%round, col='red')
text(fpi+times*30.4375, event_OS_PDL1_low+3, labels = event_OS_PDL1_low%>%round, col='blue')
text(fpi+times*30.4375, event_OS_PDL1_upp+3, labels = event_OS_PDL1_upp%>%round, col='blue')
legend(x=fpi+times[1]*30.4375,y=500,legend = c('Expected OS events', '95%-CI'), fill = c('red','blue'), bty = 'n')
```


## PFS - event projection

### Sample Size 
```{r,echo=T,message=F,warning=F, fig.width=12, fig.height=7}
mPFS_ITT_ctr <- 13
hrPFS_ITT <- 0.73

mPFS_PDL1_ctr <- 15
hrPFS_PDL1 <- 0.62

alp_PFS_ITT <- alp_PFS_PDL1 <- .025 # two-sided

pow_PFS_ITT <- .85
pow_PFS_PDL1 <- .8

rr <- 2 # Pla : Atz

info_rate_PFS_ITT <- info_rate_PFS_PDL1 <- c(1)


# accrualIntensity_ITT  <- 600/40
# accrualIntensity_PDL1 <- 600/40 * .4
# accrualTime_ITT <- accrualTime_PDL1 <- c(0,40)


accrualIntensity_PDL1 <- accrualIntensity_ITT * .4

fpi <- as.Date('2016-09-22')
times <- c(12:66)

# PFS ITT
deg_PFS_ITT <- getDesignGroupSequential(kMax=1, alpha=alp_PFS_ITT, sided = 2, beta=1-pow_PFS_ITT, informationRates = info_rate_PFS_ITT, typeOfDesign = 'asOF')

deg_PFS_ITT %>% summary 

sam_PFS_ITT <- getSampleSizeSurvival(design = deg_PFS_ITT, median2 = mPFS_ITT_ctr, hazardRatio = hrPFS_ITT, 
                                     allocationRatioPlanned = rr, 
                                     accrualTime = accrualTime_ITT, accrualIntensity = accrualIntensity_ITT)
sam_PFS_ITT %>% summary %>% print

event_PFS_ITT <- getEventProbabilities(time=times, lambda2 = log(2)/mPFS_ITT_ctr, lambda1 = log(2)/mPFS_ITT_ctr*hrPFS_ITT, allocationRatioPlanned = rr, accrualTime = accrualTime_ITT, 
                                       accrualIntensity = accrualIntensity_ITT)$overallEventProbabilities * sum(accrualIntensity_ITT)

plot(x=fpi+times*30.4375, y=event_PFS_ITT, xaxt = "n", ylab="PFS events", xlab="")
axis(1, fpi+times*30.4375, format(fpi+times*30.4375), cex.axis = .7, las=2)
text(fpi+times*30.4375, event_PFS_ITT+10, labels = event_PFS_ITT%>%round, cex = 1)

# PFS PDL1 - not at ITT
deg_PFS_PDL1 <- getDesignGroupSequential(kMax=1, alpha=alp_PFS_PDL1, sided = 2, beta=1-pow_PFS_PDL1, informationRates = info_rate_PFS_PDL1, typeOfDesign = 'asOF')

deg_PFS_PDL1 %>% summary
sam_PFS_PDL1 <- getSampleSizeSurvival(design = deg_PFS_PDL1, median2 = mPFS_PDL1_ctr, hazardRatio = hrPFS_PDL1, 
                                   allocationRatioPlanned = rr, 
                                   accrualTime = accrualTime_ITT, accrualIntensity = accrualIntensity_PDL1)
sam_PFS_PDL1 %>% summary %>% print

event_PFS_PDL1 <- getEventProbabilities(time=times, lambda2 = log(2)/mPFS_PDL1_ctr, lambda1 = log(2)/mPFS_PDL1_ctr*hrPFS_ITT, allocationRatioPlanned = rr, accrualTime = accrualTime_ITT, 
                                       accrualIntensity = accrualIntensity_PDL1)$overallEventProbabilities * sum(accrualIntensity_PDL1)

plot(x=fpi+times*30.4375, y=event_PFS_PDL1, xaxt = "n", ylab="PFS events", xlab="")
axis(1, fpi+times*30.4375, format(fpi+times*30.4375), cex.axis = .7, las=2)
text(fpi+times*30.4375, event_PFS_PDL1+7.5, labels = event_PFS_PDL1%>%round, cex = 1)

# PFS PDL1 - at ITT
(event_PFS_PDL1_at_ITT <- getEventProbabilities(time=sam_PFS_ITT$analysisTime %>% as.numeric, lambda2 = log(2)/mPFS_PDL1_ctr, lambda1 = log(2)/mPFS_PDL1_ctr*hrPFS_ITT, 
                                               allocationRatioPlanned = rr, accrualTime = accrualTime_ITT, 
                                               accrualIntensity = accrualIntensity_PDL1)$overallEventProbabilities * sum(accrualIntensity_PDL1)
)

pow_PFS_PDL1_at_ITT <- getPowerSurvival(design = deg_PFS_PDL1, median2 = mPFS_PDL1_ctr, hazardRatio = hrPFS_PDL1, 
                                        allocationRatioPlanned = rr, accrualTime = accrualTime_ITT, accrualIntensity = accrualIntensity_PDL1,
                                        maxNumberOfEvents = event_PFS_PDL1_at_ITT)

pow_PFS_PDL1_at_ITT %>% summary
```

### Potential Power Loss
```{r,echo=T,message=F,warning=F,results='asis'}

ev_frac_PFS_ITT <- ev_frac_PFS_PDL1 <- c(.95, .9, .88, .85, .8, .75)
pow_PFS_ITTs <- pow_PFS_PDL1s <- rep(numeric(0), length(ev_frac_PFS_ITT))

for(id in 1:length(ev_frac_PFS_ITT)) {

    pow_PFS_PDL1s[id] <- getPowerSurvival(design = deg_PFS_PDL1, median2 = mPFS_PDL1_ctr, hazardRatio = hrPFS_PDL1, 
                                        allocationRatioPlanned = rr, accrualTime = accrualTime_ITT, accrualIntensity = accrualIntensity_PDL1,
                                        maxNumberOfEvents = ev_frac_PFS_ITT[id]*sam_PFS_PDL1$eventsFixed)$overallReject
    
    pow_PFS_ITTs[id] <- getPowerSurvival(design = deg_PFS_ITT, median2 = mPFS_ITT_ctr, hazardRatio = hrPFS_ITT, 
                                        allocationRatioPlanned = rr, accrualTime = accrualTime_ITT, accrualIntensity = accrualIntensity_ITT,
                                        maxNumberOfEvents = ev_frac_PFS_ITT[id]*sam_PFS_ITT$eventsFixed)$overallReject    
} # end of for(id in 1:length(ev_frac_PFS_ITT))

rbind('% PFS ITT'=ev_frac_PFS_ITT, 'PFS ITT'=(ev_frac_PFS_ITT * sam_PFS_ITT$eventsFixed) %>% ceiling,  'Pow PFS ITT'=pow_PFS_ITTs %>% round(3)) %>% kable(col.names = rep('.', pow_PFS_ITTs %>% length), caption = 'PFS ITT power loss') %>% print
rbind('% PFS PDL1'=ev_frac_PFS_PDL1, 'PFS PDL1'=(ev_frac_PFS_PDL1 * sam_PFS_PDL1$eventsFixed) %>% ceiling,  'Pow PFS PDL1'=pow_PFS_PDL1s %>% round(3)) %>% kable(col.names = rep('.', pow_PFS_PDL1s %>% length), caption = 'PFS PDL1 power loss') %>% print
```


